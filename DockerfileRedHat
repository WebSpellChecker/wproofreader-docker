FROM redhat/ubi9

ARG WebServerPort=8080
ARG WebServerSSLPort=8443

EXPOSE $WebServerPort
EXPOSE $WebServerSSLPort
EXPOSE 2880

ARG FilesDir=./files
ARG DeploymentDir=/home
ARG DictionariesDir=/dictionaries
ARG CustomDictionariesDir=$DictionariesDir/CustomDictionaries
ARG UserDictionariesDir=$DictionariesDir/UserDictionaries
ARG CertDir=/certificate
ARG CertKeyName=key.pem
ARG CertFileName=cert.pem
ARG AppRootName=WSC
ARG AppRootDir=$DeploymentDir/$AppRootName
ARG AppServerDir=/opt/$AppRootName/AppServer
ARG AppNameMask=wsc_app*
ARG ssl=false
ARG UserName=wsc
ARG LicenseDir=/var/lib/wsc/license
ARG USER_ID=2000
ARG GROUP_ID=2000

COPY $FilesDir/* $DeploymentDir/

RUN	mkdir -p $CustomDictionariesDir && mkdir -p $UserDictionariesDir &&\
	mkdir $CertDir &&\
	mv $DeploymentDir/$CertKeyName $CertDir/$CertKeyName &&\
	mv $DeploymentDir/$CertFileName $CertDir/$CertFileName &&\
	yum update -y &&\
	yum install -y java-11-openjdk-devel wget perl &&\
	yum install -y http://dl.fedoraproject.org/pub/epel/epel-release-latest-7.noarch.rpm &&\
	yum install -y nginx &&\
	tar -xvf $DeploymentDir/$AppNameMask -C $DeploymentDir/ &&\
	rm $DeploymentDir/$AppNameMask &&\
	mv $AppRootDir* $AppRootDir &&\
	yum install -y mod_ssl openssl &&\
	mv $DeploymentDir/config.ini $AppRootDir/ &&\
	mkdir /var/run/nginx &&\
	perl $AppRootDir/automated_install.pl $AppRootDir/config.ini &&\
	mv $DeploymentDir/configureWebServer.pl $AppServerDir &&\
	mv $DeploymentDir/configureFiles.pl $AppServerDir &&\
	mv $DeploymentDir/startService.sh $AppServerDir &&\
	perl $DeploymentDir/configureWebPorts.pl $WebServerPort $WebServerSSLPort &&\
	chmod +x $AppServerDir/startService.sh &&\
	rm -rf /$DeploymentDir &&\
	mkdir -p $LicenseDir &&\
	mkdir -p /home &&\
	groupadd -g ${GROUP_ID} $UserName && useradd -u ${USER_ID} -g ${GROUP_ID} $UserName &&\
	chown -R ${USER_ID}:${GROUP_ID} $LicenseDir $DictionariesDir /opt/WSC /var/log/nginx /usr/sbin/nginx /var/lib/nginx /var/run/nginx /etc/nginx

USER $UserName

WORKDIR /opt/$AppRootName
ENTRYPOINT ["/opt/WSC/AppServer/startService.sh"]
